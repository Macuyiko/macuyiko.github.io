<!DOCTYPE html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width" />

	<title>Fun with Audiosurf 2 and Mitmproxy</title>

	<link rel="stylesheet" href="//blog.macuyiko.com/theme/css/normalize.css" />
	<link rel="stylesheet" href="//blog.macuyiko.com/theme/css/foundation.min.css" />
	<link rel="stylesheet" href="//blog.macuyiko.com/theme/css/style.css" />
	<link rel="stylesheet" href="//blog.macuyiko.com/theme/css/pygments.css" />	
	<script src="//blog.macuyiko.com/theme/js/jquery-3.4.1.min.js"></script>
	<link href="https://fonts.googleapis.com/css?family=Bitter:400,700|Source+Code+Pro&display=swap" rel="stylesheet">

	<script type="text/javascript">
	var waitForFinalEvent = (function () {
		var timers = {};
		return function (callback, ms, uniqueId) {
			if (!uniqueId) uniqueId = "_";
			if (timers[uniqueId]) clearTimeout (timers[uniqueId]);
			timers[uniqueId] = setTimeout(callback, ms);
		};
	})();
	var insertCaptions = function() {
		$('#articlecontainer .caption').remove();
		var width = $(window).width();
		var onmobile = width < 1400; //>
		var capclass = onmobile ? 'caption-below' : 'caption-aside';
		$.each($('#articlecontainer img'), function(index, value) {
			if ($(value).attr('alt') != undefined) {
				var elem = $('<div class="caption '+capclass+'">'+$(value).attr('alt')+'</div>');
				if (onmobile) elem.insertAfter(value);
				else elem.insertBefore(value);
			}
		});
	};
	$(function() {
		$(window).resize(function () {
			waitForFinalEvent(function(){
				insertCaptions();
			}, 500, "window.resize");
		});
		insertCaptions();
	});
	</script>
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-60406-11']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
</head>

<body>

<nav>
	<div class="top-bar large-12 columns">
		<h1><a href="//blog.macuyiko.com/">Bed Against The Wall</a></h1>
	</div>
</nav>


<div class="row contentwrapper">
	<div class="row">
<div id="articlecontainer" class="large-9 columns large-centered">
	<article>
		<header>
			<div class="article-info">Sat 24 September 2016, by Seppe "Macuyiko" vanden Broucke</div>
			<div class="article-title"><a href="//blog.macuyiko.com/post/2016/fun-with-audiosurf-2-and-mitmproxy.html" rel="bookmark"
			title="Permalink to Fun with Audiosurf 2 and Mitmproxy">Fun with Audiosurf 2 and&nbsp;Mitmproxy</a></div>
		</header>
	
	    <p>I enjoy firing up <a href="http://audiosurf2.com/">Audiosurf 2</a> from time to time to have some rythmic musical fun. One of the things that has been bothering me, however, is the fact that Audiosurf 2 only integrates with Soundcloud for its music streaming. You can use local files, but since I stream all of my music from YouTube or Spotify, this always leaves me with a limited collection of songs to choose from, and I wondered whether there was a way to circumvent&nbsp;this.</p>
<p>Enter <a href="https://mitmproxy.org/"><code>mitmproxy</code></a>, a powerful interactive console program that allows network traffic to be intercepted, inspected, modified and replayed. <code>mitmproxy</code> has a powerful <a href="http://docs.mitmproxy.org/en/stable/scripting/inlinescripts.html">scripting <span class="caps">API</span></a> that allows you to modify traffic on the fly using simple Python scripts. Perhaps we could use this to make Audiosurf 2 think it is connected to Soundcloud whilst we actually query and download music from YouTube&nbsp;instead.</p>
<p>Let&#8217;s go through the script from top to bottom. First, we set up our imports and some&nbsp;constants&#8230;</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">youtube_dl</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">parse_qs</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">quote</span>
<span class="kn">from</span> <span class="nn">mitmproxy.models</span> <span class="kn">import</span> <span class="n">HTTPResponse</span>
<span class="kn">from</span> <span class="nn">netlib.http</span> <span class="kn">import</span> <span class="n">Headers</span>

<span class="n">ENABLED</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">YOUTUBE_SHORT_ONLY</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">YDL_OPTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;bestaudio[ext=mp3]/bestaudio[ext=m4a]/bestaudio&#39;</span><span class="p">,</span>
    <span class="s1">&#39;progress_hooks&#39;</span><span class="p">:</span> <span class="p">[],</span>
<span class="c1">#   &#39;postprocessors&#39;: [{</span>
<span class="c1">#       &#39;key&#39;: &#39;FFmpegExtractAudio&#39;,</span>
<span class="c1">#       &#39;preferredcodec&#39;: &#39;mp3&#39;,</span>
<span class="c1">#       &#39;preferredquality&#39;: &#39;192&#39;,</span>
<span class="c1">#   }],</span>
<span class="p">}</span>
</pre></div>


<p>You can enable a postprocessor in <code>youtube_dl</code> (the Python library we&#8217;ll be using to handle the actual downloads from YouTube) to convert any movie to an <span class="caps">MP3</span> with FFmpeg, though this can take up a lot of time. The <code>'bestaudio[ext=mp3]/bestaudio[ext=m4a]/bestaudio'</code> format setting works&nbsp;better.</p>
<p>Next up, we need to set up a YouTube <span class="caps">API</span> key and a fake response dict representing a track as it would come from the Soundcloud <span class="caps">API</span>:</p>
<div class="highlight"><pre><span></span><span class="n">YOUTUBE_API_KEY</span> <span class="o">=</span> <span class="s1">&#39;--- get a youtube api key and set this here ---&#39;</span>
<span class="n">SOUNDCLOUD_TRACK_TEMPLATE</span> <span class="o">=</span> <span class="err">{</span>
    <span class="ss">&quot;download_url&quot;</span><span class="p">:</span><span class="k">None</span><span class="p">,</span>
    <span class="ss">&quot;key_signature&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
    <span class="ss">&quot;user_favorite&quot;</span><span class="p">:</span><span class="k">False</span><span class="p">,</span>
    <span class="ss">&quot;likes_count&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
    <span class="ss">&quot;release&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
    <span class="ss">&quot;attachments_uri&quot;</span><span class="p">:</span><span class="ss">&quot;https://api.soundcloud.com/tracks/{}/attachments&quot;</span><span class="p">,</span>
    <span class="ss">&quot;waveform_url&quot;</span><span class="p">:</span><span class="ss">&quot;https://api.soundcloud.com/tracks/{}/waveform&quot;</span><span class="p">,</span>
    <span class="ss">&quot;purchase_url&quot;</span><span class="p">:</span><span class="k">None</span><span class="p">,</span>
    <span class="ss">&quot;video_url&quot;</span><span class="p">:</span><span class="k">None</span><span class="p">,</span>
    <span class="ss">&quot;streamable&quot;</span><span class="p">:</span><span class="k">True</span><span class="p">,</span>
    <span class="ss">&quot;artwork_url&quot;</span><span class="p">:</span><span class="ss">&quot;https://api.soundcloud.com/tracks/{}/artwork&quot;</span><span class="p">,</span>
    <span class="ss">&quot;comment_count&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
    <span class="ss">&quot;commentable&quot;</span><span class="p">:</span><span class="k">True</span><span class="p">,</span>
    <span class="ss">&quot;description&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
    <span class="ss">&quot;download_count&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="ss">&quot;downloadable&quot;</span><span class="p">:</span><span class="k">False</span><span class="p">,</span>
    <span class="ss">&quot;embeddable_by&quot;</span><span class="p">:</span><span class="ss">&quot;all&quot;</span><span class="p">,</span>
    <span class="ss">&quot;favoritings_count&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="ss">&quot;genre&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
    <span class="ss">&quot;isrc&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
    <span class="ss">&quot;label_id&quot;</span><span class="p">:</span><span class="k">None</span><span class="p">,</span>
    <span class="ss">&quot;label_name&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
    <span class="ss">&quot;license&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
    <span class="ss">&quot;original_content_size&quot;</span><span class="p">:</span><span class="mi">10000</span><span class="p">,</span>
    <span class="ss">&quot;original_format&quot;</span><span class="p">:</span><span class="ss">&quot;mp3&quot;</span><span class="p">,</span>
    <span class="ss">&quot;playback_count&quot;</span><span class="p">:</span><span class="mi">10000</span><span class="p">,</span>
    <span class="ss">&quot;purchase_title&quot;</span><span class="p">:</span><span class="k">None</span><span class="p">,</span>
    <span class="ss">&quot;release_day&quot;</span><span class="p">:</span><span class="k">None</span><span class="p">,</span>
    <span class="ss">&quot;release_month&quot;</span><span class="p">:</span><span class="k">None</span><span class="p">,</span>
    <span class="ss">&quot;release_year&quot;</span><span class="p">:</span><span class="k">None</span><span class="p">,</span>
    <span class="ss">&quot;reposts_count&quot;</span><span class="p">:</span><span class="mi">10000</span><span class="p">,</span>
    <span class="ss">&quot;state&quot;</span><span class="p">:</span><span class="ss">&quot;finished&quot;</span><span class="p">,</span>
    <span class="ss">&quot;tag_list&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
    <span class="ss">&quot;track_type&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
    <span class="ss">&quot;user&quot;</span><span class="p">:</span><span class="err">{</span>
        <span class="ss">&quot;avatar_url&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
        <span class="ss">&quot;id&quot;</span><span class="p">:</span><span class="mi">111111</span><span class="p">,</span>
        <span class="ss">&quot;kind&quot;</span><span class="p">:</span><span class="ss">&quot;user&quot;</span><span class="p">,</span>
        <span class="ss">&quot;permalink_url&quot;</span><span class="p">:</span><span class="ss">&quot;https://soundcloud.com/&quot;</span><span class="p">,</span>
        <span class="ss">&quot;uri&quot;</span><span class="p">:</span><span class="ss">&quot;https://api.soundcloud.com/users/111111&quot;</span><span class="p">,</span>
        <span class="ss">&quot;username&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
        <span class="ss">&quot;permalink&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
        <span class="ss">&quot;last_modified&quot;</span><span class="p">:</span><span class="ss">&quot;2010/02/16 17:41:26 +0000&quot;</span><span class="err">}</span><span class="p">,</span>
    <span class="ss">&quot;bpm&quot;</span><span class="p">:</span><span class="k">None</span><span class="p">,</span>
    <span class="ss">&quot;user_playback_count&quot;</span><span class="p">:</span><span class="k">None</span><span class="p">,</span>
    <span class="ss">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
    <span class="ss">&quot;kind&quot;</span><span class="p">:</span><span class="ss">&quot;track&quot;</span><span class="p">,</span>
    <span class="ss">&quot;created_at&quot;</span><span class="p">:</span><span class="ss">&quot;2010/04/14 20:46:00 +0000&quot;</span><span class="p">,</span>
    <span class="ss">&quot;last_modified&quot;</span><span class="p">:</span><span class="ss">&quot;2016/08/09 23:59:27 +0000&quot;</span><span class="p">,</span>
    <span class="ss">&quot;permalink&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
    <span class="ss">&quot;permalink_url&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
    <span class="ss">&quot;title&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
    <span class="ss">&quot;duration&quot;</span><span class="p">:</span><span class="mi">253300</span><span class="p">,</span>
    <span class="ss">&quot;sharing&quot;</span><span class="p">:</span><span class="ss">&quot;public&quot;</span><span class="p">,</span>
    <span class="ss">&quot;stream_url&quot;</span><span class="p">:</span><span class="ss">&quot;https://api.soundcloud.com/tracks/{}/stream&quot;</span><span class="p">,</span>
    <span class="ss">&quot;uri&quot;</span><span class="p">:</span><span class="ss">&quot;https://api.soundcloud.com/tracks/{}&quot;</span><span class="p">,</span>
    <span class="ss">&quot;user_id&quot;</span><span class="p">:</span><span class="mi">111111</span>
<span class="err">}</span>
</pre></div>


<p>Next, we set up the actual hook to intercept all requests to <code>api.soundcloud.com</code>:</p>
<div class="highlight"><pre><span></span><span class="nv">def</span> <span class="nv">request</span><span class="ss">(</span><span class="nv">context</span>, <span class="nv">flow</span><span class="ss">)</span>:
    <span class="nv">YDL_OPTS</span>[<span class="s1">&#39;</span><span class="s">progress_hooks</span><span class="s1">&#39;</span>].<span class="nv">append</span><span class="ss">(</span><span class="nv">lambda</span> <span class="nv">d</span>: <span class="nv">youtube_download_hook</span><span class="ss">(</span><span class="nv">context</span>, <span class="nv">d</span><span class="ss">))</span>
    <span class="k">if</span> <span class="nv">ENABLED</span> <span class="nv">and</span> <span class="nv">flow</span>.<span class="nv">request</span>.<span class="nv">pretty_host</span>.<span class="nv">endswith</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">api.soundcloud.com</span><span class="s2">&quot;</span><span class="ss">)</span>:
        <span class="nv">context</span>.<span class="nv">log</span><span class="ss">(</span><span class="nv">flow</span>.<span class="nv">request</span>.<span class="nv">pretty_host</span> <span class="o">+</span> <span class="nv">flow</span>.<span class="nv">request</span>.<span class="nv">path</span><span class="ss">)</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="s">/stream</span><span class="s1">&#39;</span> <span class="nv">in</span> <span class="nv">flow</span>.<span class="nv">request</span>.<span class="nv">path</span>:
            <span class="nv">flow</span>.<span class="nv">reply</span><span class="ss">(</span><span class="nv">make_reply_stream</span><span class="ss">(</span><span class="nv">context</span>, <span class="nv">flow</span><span class="ss">))</span>
        <span class="nv">elif</span> <span class="s1">&#39;</span><span class="s">q=</span><span class="s1">&#39;</span> <span class="nv">in</span> <span class="nv">flow</span>.<span class="nv">request</span>.<span class="nv">path</span>:
            <span class="nv">flow</span>.<span class="nv">reply</span><span class="ss">(</span><span class="nv">make_reply_query</span><span class="ss">(</span><span class="nv">context</span>, <span class="nv">flow</span><span class="ss">))</span>
</pre></div>


<p>If the request contains <code>q=</code>, Audiosurf is performing a query. The other option we handle is <code>/stream</code> which whill stream back the&nbsp;track:</p>
<div class="highlight"><pre><span></span><span class="nv">def</span> <span class="nv">download_youtube_video</span><span class="ss">(</span><span class="nv">id</span><span class="ss">)</span>:
    <span class="nv">with</span> <span class="nv">youtube_dl</span>.<span class="nv">YoutubeDL</span><span class="ss">(</span><span class="nv">YDL_OPTS</span><span class="ss">)</span> <span class="nv">as</span> <span class="nv">ydl</span>:
        <span class="nb">result</span> <span class="o">=</span> <span class="nv">ydl</span>.<span class="nv">extract_info</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">http://www.youtube.com/watch?v=</span><span class="s1">&#39;</span><span class="o">+</span><span class="nv">id</span>, <span class="nv">download</span><span class="o">=</span><span class="nv">True</span><span class="ss">)</span>
        <span class="nv">video</span> <span class="o">=</span> <span class="nb">result</span>[<span class="s1">&#39;</span><span class="s">entries</span><span class="s1">&#39;</span>][<span class="mi">0</span>] <span class="k">if</span> <span class="s1">&#39;</span><span class="s">entries</span><span class="s1">&#39;</span> <span class="nv">in</span> <span class="nb">result</span> <span class="k">else</span> <span class="nb">result</span>
    <span class="k">return</span> <span class="nb">result</span>, <span class="nv">video</span>


<span class="nv">def</span> <span class="nv">youtube_download_hook</span><span class="ss">(</span><span class="nv">context</span>, <span class="nv">d</span><span class="ss">)</span>:
    <span class="k">if</span> <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">status</span><span class="s1">&#39;</span>] <span class="o">==</span> <span class="s1">&#39;</span><span class="s">finished</span><span class="s1">&#39;</span>:
        <span class="nv">context</span>.<span class="nv">__filename</span> <span class="o">=</span> <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">filename</span><span class="s1">&#39;</span>]


<span class="nv">def</span> <span class="nv">make_reply_stream</span><span class="ss">(</span><span class="nv">context</span>, <span class="nv">flow</span><span class="ss">)</span>:
    <span class="nv">resp</span> <span class="o">=</span> <span class="nv">HTTPResponse</span><span class="ss">(</span><span class="nv">b</span><span class="s2">&quot;</span><span class="s">HTTP/1.1</span><span class="s2">&quot;</span>, <span class="mi">200</span>, <span class="nv">b</span><span class="s2">&quot;</span><span class="s">OK</span><span class="s2">&quot;</span>,
            <span class="nv">Headers</span><span class="ss">(</span><span class="nv">Content_Type</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">audio/mpeg</span><span class="s2">&quot;</span><span class="ss">)</span>, <span class="nv">b</span><span class="s2">&quot;&quot;</span><span class="ss">)</span>
    <span class="nv">id</span> <span class="o">=</span> <span class="nv">flow</span>.<span class="nv">request</span>.<span class="nv">path</span>.<span class="nv">split</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">/</span><span class="s1">&#39;</span><span class="ss">)</span>[<span class="mi">2</span>]
    <span class="nv">context</span>.<span class="nv">__filename</span> <span class="o">=</span> <span class="nv">None</span>
    <span class="nv">context</span>.<span class="nv">log</span><span class="ss">(</span><span class="nv">id</span><span class="ss">)</span>
    <span class="nb">result</span>, <span class="nv">video</span> <span class="o">=</span> <span class="nv">download_youtube_video</span><span class="ss">(</span><span class="nv">id</span><span class="ss">)</span>
    <span class="k">while</span> <span class="nv">not</span> <span class="nv">context</span>.<span class="nv">__filename</span>:
        <span class="nv">sleep</span><span class="ss">(</span><span class="mi">200</span><span class="ss">)</span>
    <span class="nv">context</span>.<span class="nv">log</span><span class="ss">(</span><span class="nv">context</span>.<span class="nv">__filename</span><span class="ss">)</span>
    <span class="nv">resp</span>.<span class="nv">content</span> <span class="o">=</span> <span class="nv">open</span><span class="ss">(</span><span class="nv">context</span>.<span class="nv">__filename</span>, <span class="s1">&#39;</span><span class="s">rb</span><span class="s1">&#39;</span><span class="ss">)</span>.<span class="nv">read</span><span class="ss">()</span>
    <span class="k">return</span> <span class="nv">resp</span>


<span class="nv">def</span> <span class="nv">make_reply_query</span><span class="ss">(</span><span class="nv">context</span>, <span class="nv">flow</span><span class="ss">)</span>:
    <span class="nv">resp</span> <span class="o">=</span> <span class="nv">HTTPResponse</span><span class="ss">(</span><span class="nv">b</span><span class="s2">&quot;</span><span class="s">HTTP/1.1</span><span class="s2">&quot;</span>, <span class="mi">200</span>, <span class="nv">b</span><span class="s2">&quot;</span><span class="s">OK</span><span class="s2">&quot;</span>,
            <span class="nv">Headers</span><span class="ss">(</span><span class="nv">Content_Type</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">application/json</span><span class="s2">&quot;</span><span class="ss">)</span>, <span class="nv">b</span><span class="s2">&quot;&quot;</span><span class="ss">)</span>
    <span class="nv">bits</span> <span class="o">=</span> <span class="nv">urlparse</span><span class="ss">(</span><span class="nv">flow</span>.<span class="nv">request</span>.<span class="nv">path</span><span class="ss">)</span>
    <span class="nv">query</span> <span class="o">=</span> <span class="nv">parse_qs</span><span class="ss">(</span><span class="nv">bits</span>.<span class="nv">query</span><span class="ss">)</span>[<span class="s1">&#39;</span><span class="s">q</span><span class="s1">&#39;</span>][<span class="mi">0</span>]
    <span class="nv">list</span> <span class="o">=</span> <span class="nv">make_song_list</span><span class="ss">(</span><span class="nv">query</span>, <span class="nv">context</span><span class="ss">)</span>
    <span class="nv">resp</span>.<span class="nv">content</span> <span class="o">=</span> <span class="nv">json</span>.<span class="nv">dumps</span><span class="ss">(</span><span class="nv">list</span><span class="ss">)</span>.<span class="nv">encode</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">utf-8</span><span class="s1">&#39;</span><span class="ss">)</span>
    <span class="k">return</span> <span class="nv">resp</span>
</pre></div>


<p>Note that we use some <code>youtube_dl</code> hook trickery to make sure we wait until the file is downloaded. (<code>youtube_dl</code> will spawn a separate&nbsp;process.)</p>
<p>Finally, we need to implement two more&nbsp;functions:</p>
<div class="highlight"><pre><span></span><span class="nv">def</span> <span class="nv">make_song_dict</span><span class="ss">(</span><span class="nv">id</span>, <span class="nv">title</span>, <span class="nv">artist</span>, <span class="nv">description</span><span class="o">=</span><span class="s1">&#39;&#39;</span>, <span class="nv">artwork_url</span><span class="o">=</span><span class="nv">None</span><span class="ss">)</span>:
    <span class="nv">d</span> <span class="o">=</span> <span class="nv">copy</span>.<span class="nv">deepcopy</span><span class="ss">(</span><span class="nv">SOUNDCLOUD_TRACK_TEMPLATE</span><span class="ss">)</span>
    <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">id</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="nv">id</span>
    <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">title</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="nv">title</span>
    <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">description</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="nv">description</span>
    <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">attachments_uri</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">attachments_uri</span><span class="s1">&#39;</span>].<span class="nv">format</span><span class="ss">(</span><span class="nv">id</span><span class="ss">)</span>
    <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">waveform_url</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">waveform_url</span><span class="s1">&#39;</span>].<span class="nv">format</span><span class="ss">(</span><span class="nv">id</span><span class="ss">)</span>
    <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">artwork_url</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">artwork_url</span><span class="s1">&#39;</span>].<span class="nv">format</span><span class="ss">(</span><span class="nv">id</span><span class="ss">)</span>
    <span class="k">if</span> <span class="nv">artwork_url</span> <span class="nv">is</span> <span class="nv">not</span> <span class="nv">None</span>:
        <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">artwork_url</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="nv">artwork_url</span>
    <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">stream_url</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">stream_url</span><span class="s1">&#39;</span>].<span class="nv">format</span><span class="ss">(</span><span class="nv">id</span><span class="ss">)</span>
    <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">uri</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">uri</span><span class="s1">&#39;</span>].<span class="nv">format</span><span class="ss">(</span><span class="nv">id</span><span class="ss">)</span>
    <span class="nv">d</span>[<span class="s1">&#39;</span><span class="s">user</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">username</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="nv">artist</span>
    <span class="k">return</span> <span class="nv">d</span>


<span class="nv">def</span> <span class="nv">make_song_list</span><span class="ss">(</span><span class="nv">query</span>, <span class="nv">context</span><span class="ss">)</span>:
    <span class="nv">q</span> <span class="o">=</span> <span class="nv">quote</span><span class="ss">(</span><span class="nv">query</span><span class="ss">)</span>
    <span class="nv">vd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">short</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="nv">YOUTUBE_SHORT_ONLY</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="s">any</span><span class="s1">&#39;</span>
    <span class="nv">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">https://www.googleapis.com/youtube/v3/search?part=snippet&amp;maxResults=50&amp;q={q}&amp;type=video&amp;videoCategoryId=10&amp;videoDuration={vd}&amp;key={key}</span><span class="s1">&#39;</span>.<span class="nv">format</span><span class="ss">(</span><span class="nv">q</span><span class="o">=</span><span class="nv">q</span>, <span class="nv">vd</span><span class="o">=</span><span class="nv">vd</span>, <span class="nv">key</span><span class="o">=</span><span class="nv">YOUTUBE_API_KEY</span><span class="ss">)</span>
    <span class="nv">reply</span> <span class="o">=</span> <span class="nv">requests</span>.<span class="nv">get</span><span class="ss">(</span><span class="nv">url</span><span class="ss">)</span>.<span class="nv">json</span><span class="ss">()</span>
    <span class="nv">list</span> <span class="o">=</span> []
    <span class="k">for</span> <span class="nv">item</span> <span class="nv">in</span> <span class="nv">reply</span>[<span class="s1">&#39;</span><span class="s">items</span><span class="s1">&#39;</span>]:
        <span class="nv">d</span> <span class="o">=</span> <span class="nv">make_song_dict</span><span class="ss">(</span><span class="nv">item</span>[<span class="s1">&#39;</span><span class="s">id</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">videoId</span><span class="s1">&#39;</span>],
            <span class="nv">title</span><span class="o">=</span><span class="nv">item</span>[<span class="s1">&#39;</span><span class="s">snippet</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">title</span><span class="s1">&#39;</span>],
            <span class="nv">artist</span><span class="o">=</span><span class="nv">item</span>[<span class="s1">&#39;</span><span class="s">snippet</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">channelTitle</span><span class="s1">&#39;</span>],
            <span class="nv">description</span><span class="o">=</span><span class="nv">item</span>[<span class="s1">&#39;</span><span class="s">snippet</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">description</span><span class="s1">&#39;</span>],
            <span class="nv">artwork_url</span><span class="o">=</span><span class="nv">item</span>[<span class="s1">&#39;</span><span class="s">snippet</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">thumbnails</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">default</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">url</span><span class="s1">&#39;</span>]<span class="ss">)</span>
        <span class="nv">list</span>.<span class="nv">append</span><span class="ss">(</span><span class="nv">d</span><span class="ss">)</span>
    <span class="k">return</span> <span class="nv">list</span>
</pre></div>


<p>And we&#8217;re done! We can use Proxifier <span class="caps">PE</span> or another program to force connections from Audiosurf 2 to go through our man in the middle server. You can see the result in action&nbsp;here:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/K3LDeERn9Jw" frameborder="0" allowfullscreen></iframe>

<p>Final warning: this is meant to be a fun weekend experiment and in no way provided to circumvent YouTube or other streaming provider&#8217;s policies. Just as using <code>youtube_dl</code>, use this at your own&nbsp;risk!</p>
	</article>
</div>
		
	</div>

	<footer class="row">
		<div class="large-12 columns">
			<hr />
			<div class="row">
				<p>Bed Against The Wall by Seppe "Macuyiko" vanden Broucke<br>
				Unless mentioned otherwise, this work is licensed under a <a href="http://creativecommons.org/licenses/by-sa/2.0/be/" rel="license">Creative Commons Attribution-Share Alike 2.0 Belgium License</a>.<br>
				Static blog engine powered by <a href="http://getpelican.com">Pelican</a>.</p>
			</div>
		</div>
	</footer>
</div>
 